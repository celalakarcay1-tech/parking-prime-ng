<div class="card">
  <div class="table-header">
    <h2>Ödeme İşlemleri</h2>
    <div class="header-actions">
      <div class="search-container">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input 
            type="text" 
            pInputText 
            [(ngModel)]="globalFilter" 
            placeholder="Plaka, ödeme tipi veya yöntem ile ara..." 
            (input)="onGlobalFilter($event)"
          />
        </span>
        <p-button 
          label="Temizle" 
          icon="pi pi-filter-slash" 
          (onClick)="clearFilters()"
          [outlined]="true"
          styleClass="ml-2">
        </p-button>
      </div>
      <p-button 
        label="Yeni Ödeme" 
        icon="pi pi-plus" 
        (onClick)="openNew()"
        styleClass="ml-2">
      </p-button>
    </div>
  </div>

  <p-table 
    [value]="filteredPayments" 
    [paginator]="true" 
    [rows]="10"
    [showCurrentPageReport]="true" 
    currentPageReportTemplate="Toplam {totalRecords} kayıttan {first} - {last} arası gösteriliyor"
    [rowsPerPageOptions]="[5, 10, 25, 50, 100]"
    [virtualScroll]="filteredPayments.length > 1000"
    [virtualScrollItemSize]="46"
    [tableStyle]="{'min-width': '70rem'}"
    styleClass="p-datatable-striped p-datatable-gridlines"
    [selection]="selectedPayments"
    dataKey="id"
    [scrollable]="true"
    scrollHeight="500px">
    
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th pSortableColumn="plateNumber" style="width: 12%">
          Plaka <p-sortIcon field="plateNumber"></p-sortIcon>
        </th>
        <th pSortableColumn="amount" style="width: 12%">
          Tutar <p-sortIcon field="amount"></p-sortIcon>
        </th>
        <th pSortableColumn="paymentDate" style="width: 12%">
          Tarih <p-sortIcon field="paymentDate"></p-sortIcon>
        </th>
        <th pSortableColumn="paymentType" style="width: 12%">
          Ödeme Tipi <p-sortIcon field="paymentType"></p-sortIcon>
        </th>
        <th pSortableColumn="paymentMethod" style="width: 12%">
          Ödeme Yöntemi <p-sortIcon field="paymentMethod"></p-sortIcon>
        </th>
        <th pSortableColumn="status" style="width: 12%">
          Durum <p-sortIcon field="status"></p-sortIcon>
        </th>
        <th style="width: 15%">Açıklama</th>
        <th style="width: 10%">İşlemler</th>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="body" let-payment>
      <tr>
        <td>
          <p-tableCheckbox [value]="payment"></p-tableCheckbox>
        </td>
        <td><strong>{{ payment.plateNumber }}</strong></td>
        <td><strong class="amount-text">{{ payment.amount | currency:'TRY':'symbol':'1.2-2' }}</strong></td>
        <td>{{ payment.paymentDate | date:'dd.MM.yyyy HH:mm' }}</td>
        <td>{{ getPaymentTypeLabel(payment.paymentType) }}</td>
        <td>{{ getPaymentMethodLabel(payment.paymentMethod) }}</td>
        <td>
          <p-tag 
            [value]="getStatusLabel(payment.status)" 
            [severity]="getStatusSeverity(payment.status)">
          </p-tag>
        </td>
        <td>{{ payment.description || '-' }}</td>
        <td>
          <div class="action-buttons">
            <p-button 
              icon="pi pi-pencil" 
              [rounded]="true"
              [text]="true"
              (onClick)="editPayment(payment)"
              pTooltip="Düzenle"
              tooltipPosition="top">
            </p-button>
            <p-button 
              icon="pi pi-trash" 
              [rounded]="true"
              [text]="true"
              [severity]="'danger'"
              (onClick)="deletePayment(payment)"
              pTooltip="Sil"
              tooltipPosition="top">
            </p-button>
          </div>
        </td>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="summary">
      <div class="summary-footer">
        <div class="summary-item">
          <strong>Toplam Ödeme:</strong> {{ filteredPayments.length }}
        </div>
        <div class="summary-item">
          <strong>Toplam Gelir:</strong> 
          {{ getTotalRevenue() | currency:'TRY':'symbol':'1.2-2' }}
        </div>
      </div>
    </ng-template>
    
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="9" class="empty-message">
          <div class="empty-content">
            <i class="pi pi-inbox" style="font-size: 3rem; color: #ccc;"></i>
            <p>Kayıt bulunamadı.</p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Ödeme Ekleme/Düzenleme Dialog -->
<p-dialog 
  [(visible)]="displayDialog" 
  [header]="isEditMode ? 'Ödeme Düzenle' : 'Yeni Ödeme Ekle'"
  [modal]="true"
  [style]="{width: '500px'}"
  [closable]="true">
  
  <div class="dialog-content">
    <div class="form-group">
      <label>Plaka *</label>
      <input type="text" pInputText [(ngModel)]="payment.plateNumber" placeholder="34ABC123" />
    </div>

    <div class="form-group">
      <label>Tutar (₺) *</label>
      <p-inputNumber 
        [(ngModel)]="payment.amount" 
        mode="decimal"
        [min]="0"
        [max]="100000"
        [useGrouping]="false"
        styleClass="w-full">
      </p-inputNumber>
    </div>

    <div class="form-group">
      <label>Ödeme Tarihi *</label>
      <p-calendar 
        [(ngModel)]="payment.paymentDate" 
        [showTime]="true"
        [showIcon]="true"
        dateFormat="dd.mm.yy"
        styleClass="w-full">
      </p-calendar>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Ödeme Tipi *</label>
        <p-dropdown 
          [(ngModel)]="payment.paymentType" 
          [options]="paymentTypes"
          optionLabel="label"
          optionValue="value"
          placeholder="Tip seçin"
          styleClass="w-full">
        </p-dropdown>
      </div>
      <div class="form-group">
        <label>Ödeme Yöntemi *</label>
        <p-dropdown 
          [(ngModel)]="payment.paymentMethod" 
          [options]="paymentMethods"
          optionLabel="label"
          optionValue="value"
          placeholder="Yöntem seçin"
          styleClass="w-full">
        </p-dropdown>
      </div>
    </div>

    <div class="form-group">
      <label>Durum *</label>
      <p-dropdown 
        [(ngModel)]="payment.status" 
        [options]="[
          {label: 'Tamamlandı', value: 'completed'},
          {label: 'Beklemede', value: 'pending'},
          {label: 'Başarısız', value: 'failed'}
        ]"
        optionLabel="label"
        optionValue="value"
        styleClass="w-full">
      </p-dropdown>
    </div>

    <div class="form-group">
      <label>Açıklama</label>
      <input type="text" pInputText [(ngModel)]="payment.description" placeholder="Açıklama girin" />
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button 
      label="İptal" 
      icon="pi pi-times" 
      (onClick)="displayDialog = false"
      [outlined]="true">
    </p-button>
    <p-button 
      label="Kaydet" 
      icon="pi pi-check" 
      (onClick)="savePayment()">
    </p-button>
  </ng-template>
</p-dialog>

