<div class="card">
  <div class="table-header">
    <h2>Abonelik Yönetimi</h2>
    <div class="header-actions">
      <div class="search-container">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input 
            type="text" 
            pInputText 
            [(ngModel)]="globalFilter" 
            placeholder="Plaka veya sahip adı ile ara..." 
            (input)="onGlobalFilter($event)"
          />
        </span>
        <p-button 
          label="Temizle" 
          icon="pi pi-filter-slash" 
          (onClick)="clearFilters()"
          [outlined]="true"
          styleClass="ml-2">
        </p-button>
      </div>
      <p-button 
        label="Yeni Abonelik" 
        icon="pi pi-plus" 
        (onClick)="openNew()"
        styleClass="ml-2">
      </p-button>
    </div>
  </div>

  <p-table 
    [value]="filteredSubscriptions" 
    [paginator]="true" 
    [rows]="10"
    [showCurrentPageReport]="true" 
    currentPageReportTemplate="Toplam {totalRecords} kayıttan {first} - {last} arası gösteriliyor"
    [rowsPerPageOptions]="[5, 10, 25, 50, 100]"
    [virtualScroll]="filteredSubscriptions.length > 1000"
    [virtualScrollItemSize]="46"
    [tableStyle]="{'min-width': '70rem'}"
    styleClass="p-datatable-striped p-datatable-gridlines"
    [selection]="selectedSubscriptions"
    dataKey="id"
    [scrollable]="true"
    scrollHeight="500px">
    
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th pSortableColumn="plateNumber" style="width: 12%">
          Plaka <p-sortIcon field="plateNumber"></p-sortIcon>
        </th>
        <th pSortableColumn="ownerName" style="width: 15%">
          Sahip Adı <p-sortIcon field="ownerName"></p-sortIcon>
        </th>
        <th pSortableColumn="startDate" style="width: 12%">
          Başlangıç <p-sortIcon field="startDate"></p-sortIcon>
        </th>
        <th pSortableColumn="endDate" style="width: 12%">
          Bitiş <p-sortIcon field="endDate"></p-sortIcon>
        </th>
        <th pSortableColumn="planType" style="width: 10%">
          Plan Tipi <p-sortIcon field="planType"></p-sortIcon>
        </th>
        <th pSortableColumn="price" style="width: 10%">
          Fiyat <p-sortIcon field="price"></p-sortIcon>
        </th>
        <th pSortableColumn="status" style="width: 10%">
          Durum <p-sortIcon field="status"></p-sortIcon>
        </th>
        <th pSortableColumn="paymentStatus" style="width: 10%">
          Ödeme <p-sortIcon field="paymentStatus"></p-sortIcon>
        </th>
        <th style="width: 9%">İşlemler</th>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="body" let-subscription>
      <tr>
        <td>
          <p-tableCheckbox [value]="subscription"></p-tableCheckbox>
        </td>
        <td><strong>{{ subscription.plateNumber }}</strong></td>
        <td>{{ subscription.ownerName }}</td>
        <td>{{ subscription.startDate | date:'dd.MM.yyyy' }}</td>
        <td>{{ subscription.endDate | date:'dd.MM.yyyy' }}</td>
        <td>{{ getPlanTypeLabel(subscription.planType) }}</td>
        <td><strong>{{ subscription.price | currency:'TRY':'symbol':'1.0-0' }}</strong></td>
        <td>
          <p-tag 
            [value]="getStatusLabel(subscription.status)" 
            [severity]="getStatusSeverity(subscription.status)">
          </p-tag>
        </td>
        <td>
          <p-tag 
            [value]="getPaymentStatusLabel(subscription.paymentStatus)" 
            [severity]="getPaymentStatusSeverity(subscription.paymentStatus)">
          </p-tag>
        </td>
        <td>
          <div class="action-buttons">
            <p-button 
              icon="pi pi-pencil" 
              [rounded]="true"
              [text]="true"
              (onClick)="editSubscription(subscription)"
              pTooltip="Düzenle"
              tooltipPosition="top">
            </p-button>
            <p-button 
              icon="pi pi-trash" 
              [rounded]="true"
              [text]="true"
              [severity]="'danger'"
              (onClick)="deleteSubscription(subscription)"
              pTooltip="Sil"
              tooltipPosition="top">
            </p-button>
          </div>
        </td>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="10" class="empty-message">
          <div class="empty-content">
            <i class="pi pi-inbox" style="font-size: 3rem; color: #ccc;"></i>
            <p>Kayıt bulunamadı.</p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Abonelik Ekleme/Düzenleme Dialog -->
<p-dialog 
  [(visible)]="displayDialog" 
  [header]="isEditMode ? 'Abonelik Düzenle' : 'Yeni Abonelik Ekle'"
  [modal]="true"
  [style]="{width: '500px'}"
  [closable]="true">
  
  <div class="dialog-content">
    <div class="form-group">
      <label>Plaka *</label>
      <input type="text" pInputText [(ngModel)]="subscription.plateNumber" placeholder="34ABC123" />
    </div>

    <div class="form-group">
      <label>Sahip Adı *</label>
      <input type="text" pInputText [(ngModel)]="subscription.ownerName" placeholder="Ahmet Yılmaz" />
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Başlangıç Tarihi *</label>
        <p-calendar 
          [(ngModel)]="subscription.startDate" 
          [showIcon]="true"
          dateFormat="dd.mm.yy"
          styleClass="w-full">
        </p-calendar>
      </div>
      <div class="form-group">
        <label>Bitiş Tarihi *</label>
        <p-calendar 
          [(ngModel)]="subscription.endDate" 
          [showIcon]="true"
          dateFormat="dd.mm.yy"
          styleClass="w-full">
        </p-calendar>
      </div>
    </div>

    <div class="form-group">
      <label>Plan Tipi *</label>
      <p-dropdown 
        [(ngModel)]="subscription.planType" 
        [options]="planTypes"
        optionLabel="label"
        optionValue="value"
        (onChange)="calculatePrice()"
        placeholder="Plan seçin"
        styleClass="w-full">
      </p-dropdown>
    </div>

    <div class="form-group">
      <label>Fiyat (₺) *</label>
      <input type="number" pInputText [(ngModel)]="subscription.price" placeholder="500" />
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Durum *</label>
        <p-dropdown 
          [(ngModel)]="subscription.status" 
          [options]="[
            {label: 'Aktif', value: 'active'},
            {label: 'Süresi Dolmuş', value: 'expired'},
            {label: 'İptal Edilmiş', value: 'cancelled'}
          ]"
          optionLabel="label"
          optionValue="value"
          styleClass="w-full">
        </p-dropdown>
      </div>
      <div class="form-group">
        <label>Ödeme Durumu *</label>
        <p-dropdown 
          [(ngModel)]="subscription.paymentStatus" 
          [options]="[
            {label: 'Ödendi', value: 'paid'},
            {label: 'Beklemede', value: 'pending'},
            {label: 'Gecikmiş', value: 'overdue'}
          ]"
          optionLabel="label"
          optionValue="value"
          styleClass="w-full">
        </p-dropdown>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button 
      label="İptal" 
      icon="pi pi-times" 
      (onClick)="displayDialog = false"
      [outlined]="true">
    </p-button>
    <p-button 
      label="Kaydet" 
      icon="pi pi-check" 
      (onClick)="saveSubscription()">
    </p-button>
  </ng-template>
</p-dialog>

